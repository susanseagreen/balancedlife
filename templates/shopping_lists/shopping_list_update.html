{% extends 'base.html' %}
{% load static crispy_forms_tags get_display %}

{% block content %}

    <div id="myModal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-center mb-2">
        <a class="btn btn-info m-1" href="{% url 'shopping_lists:list' pk %}">
            View Shopping List
        </a>
        <a class="btn btn-info m-1" href="{% url 'shopping_lists:food_diary' pk %}">
            View Food Diary
        </a>
    </div>

    <form method="post" action="{% url 'shopping_lists:update' pk %}" class="border p-3 mb-3">
        {% csrf_token %}
        <fieldset>
            {% crispy form %}
        </fieldset>
    </form>

    <div class="d-flex justify-content-center">
        <a class="modal_create_meal btn btn-dark m-1" data-toggle="modal" href="javascript:void(0);">
            Meals
        </a>
        <a class="modal_create_ingredient btn btn-dark m-1" data-toggle="modal" href="javascript:void(0);">
            Ingredients
        </a>
        <a class="modal_create_other btn btn-dark m-1" data-toggle="modal" href="javascript:void(0);">
            Other Items
        </a>
    </div>

    <br>
    <hr>
    <br>

    <div class="text-center">
        <h3>{{ shopping_list.name }}</h3>

        <br>

        {% if shopping_list.date_from %}
            {{ shopping_list.date_from | date:"D d M Y" }} - {{ shopping_list.date_to | date:"D d M Y" }}
        {% endif %}
    </div>
    <br>
    <table class="table m-0 table-bordered">
        {% for id, ingredient in ingredient_list.items %}

            <tr>
                <td class="p-0" style="width: 100px">
                    <a class="cursor-pointer" title="See More"
                       onclick="return showItems(this,'{{ ingredient.id }}')">
                        <table class="table m-0 table-borderless">
                            <tr>
                                <td style="width: 100px">
                                    {% if ingredient.measurement_type.fraction %}
                                        {{ ingredient.measurement_type.fraction }}
                                    {% endif %}
                                    {% if ingredient.i %}{{ ingredient.i | no_decimals }}{% endif %}
                                    {% if ingredient.g %}{{ ingredient.g | no_decimals }}{% endif %}
                                    {% if ingredient.kg %}{{ ingredient.kg | no_decimals }}{% endif %}
                                    {% if ingredient.dp %}{{ ingredient.dp | no_decimals }}{% endif %}
                                    {% if ingredient.tsp %}{{ ingredient.tsp | no_decimals }}{% endif %}
                                    {% if ingredient.tbsp %}{{ ingredient.tbsp | no_decimals }}{% endif %}
                                    {% if ingredient.c %}{{ ingredient.c | no_decimals }}{% endif %}
                                    {% if ingredient.ml %}{{ ingredient.ml | no_decimals }}{% endif %}
                                    {% if ingredient.l %}{{ ingredient.l | no_decimals }}{% endif %}
                                    {% if ingredient.measurement_type and ingredient.measurement_type.measurement_type != 'i' %}
                                        {{ ingredient.measurement_type.measurement_type }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ingredient.ingredient_name %}
                                        {{ ingredient.ingredient_name }}
                                    {% else %}
                                        {{ ingredient.name }}
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </a>
                </td>
            </tr>
            <tr>
                <td colspan="2" class="p-0">
                    <div style='width:100%;display:none;' id='d_{{ ingredient.id }}'>
                        <table class="table m-0 table-borderless small">
                            {% for added in ingredient.added %}
                                <tr class="border-bottom">
                                    <td class="p-2" style="width: 100px">
                                        <a class="modal_update_ingredient p-2 cursor-pointer"
                                           data-toggle="modal"
                                           href="javascript:void(0);"
                                                {% if added.code_ingredient__name %}
                                           id="{% url 'shopping_list_items:update_ingredient_modal' added.id %}">
                                                {% else %}
                                                    id="{% url 'shopping_list_items:update_item_modal' added.id %}">
                                                {% endif %}

                                        {% if added.measurement_value or added.measurement_type %}
                                            <span {% if added.measurement_value %}
                                                title="{{ added.measurement_type | measurement_type_display }}"
                                            {% endif %}>
                                                    {% if added.measurement_value %}
                                                        {{ added.measurement_value | no_decimals }}
                                                    {% else %}
                                                        {{ added.fraction }}
                                                    {% endif %}
                                                {% if added.measurement_type %}
                                                    {{ added.measurement_type }}
                                                {% endif %}
                                                </span>
                                        {% else %}
                                            -
                                        {% endif %}
                                        </a>
                                    </td>
                                    <td class="p-2 small cursor-pointer"
                                        {% if added.servings %}title="{{ added.servings }}"{% endif %}>
                                        {% if added.code_meal_ingredient__code_meal__name %}
                                            {{ added.code_meal_ingredient__code_meal__name }}
                                        {% else %}
                                            {% if added.code_ingredient__name %}
                                                {{ added.code_ingredient__name }}
                                            {% else %}
                                                {{ added.name }}
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="p-2 small">
                                        {% for day_of_week in added.day_of_week %}
                                            <span class="day_of_week">{{ day_of_week | day_of_week_display }}</span>
                                        {% endfor %}
                                    </td>
                                    <td class="p-2 small text-right">
                                        {% for meal in added.meal %}
                                            <span class="meal">{{ meal | meal_display }}</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                            {% endfor %}
                            {% for removed in ingredient.removed %}
                                <tr class="border-bottom">
                                    <td class="p-2" style="width: 100px">
                                        <a class="modal_update_ingredient p-2 cursor-pointer"
                                           data-toggle="modal"
                                           href="javascript:void(0);" style="color: red"
                                                {% if removed.code_ingredient__name %}
                                           id="{% url 'shopping_list_items:update_ingredient_modal' removed.id %}">
                                                {% else %}
                                                    id="{% url 'shopping_list_items:update_item_modal' removed.id %}">
                                                {% endif %}
                                        {% if removed.measurement_value or removed.measurement_type %}
                                            {% if removed.measurement_value %}
                                                {{ removed.measurement_value | no_decimals }}
                                            {% else %}
                                                {{ removed.fraction }}
                                            {% endif %}
                                            {% if removed.measurement_type %}
                                                <span title="{{ removed.measurement_type | measurement_type_display }}">
                                                        {{ removed.measurement_type }}
                                                    </span>
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                        </a>
                                    </td>
                                    <td class="p-2 small cursor-pointer"
                                        {% if removed.servings %}title="{{ removed.servings }}"{% endif %}>
                                        {% if removed.code_meal_ingredient__code_meal__name %}
                                            {{ removed.code_meal_ingredient__code_meal__name }}
                                        {% else %}
                                            {% if removed.code_ingredient__name %}
                                                {{ removed.code_ingredient__name }}
                                            {% else %}
                                                {{ removed.name }}
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="p-2 small">
                                        {% for day_of_week in removed.day_of_week %}
                                            <span class="day_of_week">{{ day_of_week | day_of_week_display }}</span>
                                        {% endfor %}
                                    </td>
                                    <td class="p-2 small text-right">
                                        {% for meal in removed.meal %}
                                            <span class="meal">{{ meal | meal_display }}</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                </td>
            </tr>
        {% endfor %}
    </table>

    <br>

    <script>
        $(document).ready(function () {
            $('.toggle_dates').hide()
            jQuery('.modal_create_meal').click(function (e) {
                $('.modal-body').load("{% url 'shopping_list_items:create_meal_modal' pk %}", function (result) {
                    $('#myModal').modal({show: true});
                });
            });
            jQuery('.modal_create_ingredient').click(function (e) {
                $('.modal-body').load("{% url 'shopping_list_items:create_ingredient_modal' pk %}", function (result) {
                    $('#myModal').modal({show: true});
                });
            });
            jQuery('.modal_create_other').click(function (e) {
                $('.modal-body').load("{% url 'shopping_list_items:create_item_modal' pk %}", function (result) {
                    $('#myModal').modal({show: true});
                });
            });
            jQuery('.modal_update_ingredient').click(function (e) {
                var linkvar = $(this).attr('id');
                $('.modal-body').load(linkvar, function (result) {
                    $('#myModal').modal({show: true});
                });
            });
            jQuery('.modal_update_item').click(function (e) {
                var linkvar = $(this).attr('id');
                $('.modal-body').load(linkvar, function (result) {
                    $('#myModal').modal({show: true});
                });
            });
            $(".button_toggle_dates").click(function(){
                $('.toggle_dates').fadeToggle()
                this.innerText = (this.innerText === '-' ? '+' : '-')
            });
        });
    </script>
    <script src="{% static 'javascript/showitems.js' %}"></script>

{% endblock content %}

{% block meals %}
    <div class="col-12">
        <h3>Meals in this List</h3>
    </div>
    {% if ingredient_list %}
        {% for id, ingredient in ingredient_list.items %}
            {% if ingredient.added and ingredient.ingredient_id %}
                {% ifchanged ingredient.meal_names %}
                    <table class="table border">
                        {% for meal_name in ingredient.meal_names %}
                            <tr>
                                <td>
                                    <div class="d-flex justify-content-between">
                                        <div>{{ meal_name }}</div>
                                        <div class="text-right">
                                            <span class="meal_category">
                                            {{ ingredient.category_name }}
                                            </span>
                                        </div>
                                    </div>

                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                {% endifchanged %}
            {% endif %}
        {% endfor %}
    {% else %}
        <table class="table border">
            <tr>
                <td>
                    No meals created
                </td>
            </tr>
        </table>
    {% endif %}
{% endblock meals %}